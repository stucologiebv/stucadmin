<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mijn Uren - StucAdmin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f3f4f6; min-height: 100vh; }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; }
        .input-field:focus { outline: none; border-color: #6366f1; }
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #e5e7eb; }
        .btn-success { background: #10b981; color: white; }
        .uren-card { border-left: 4px solid #6366f1; }
        .hidden { display: none !important; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body>
    <header class="text-white p-4 shadow-lg">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">‚è±Ô∏è Mijn Uren</h1>
                <p class="text-sm opacity-80" id="welcomeMsg">Welkom</p>
            </div>
            <button onclick="logout()" class="text-white opacity-80 hover:opacity-100">
                Uitloggen ‚Üí
            </button>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4 space-y-4">
        <!-- Nieuwe uren registreren -->
        <div class="card p-6">
            <h2 class="text-lg font-bold mb-4">üìù Uren Registreren</h2>
            
            <div class="space-y-4">
                <!-- Project -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Project *</label>
                    <select id="projectSelect" class="input-field">
                        <option value="">Selecteer project...</option>
                    </select>
                </div>

                <!-- Datum -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Datum *</label>
                    <input type="date" id="datumInput" class="input-field">
                </div>

                <!-- Tijden -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Begintijd *</label>
                        <input type="time" id="begintijdInput" class="input-field" value="08:00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Eindtijd *</label>
                        <input type="time" id="eindtijdInput" class="input-field" value="16:30">
                    </div>
                </div>

                <!-- Pauze -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pauze (minuten)</label>
                    <input type="number" id="pauzeInput" class="input-field" value="30" min="0" step="5">
                </div>

                <!-- Notitie -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notitie</label>
                    <textarea id="notitieInput" class="input-field" rows="3" placeholder="Wat heb je gedaan? Bijzonderheden..."></textarea>
                </div>

                <!-- Totaal preview -->
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-indigo-700 font-medium">Totaal uren:</span>
                        <span class="text-2xl font-bold text-indigo-600" id="totaalPreview">8.0</span>
                    </div>
                </div>

                <button onclick="saveUren()" class="btn btn-success w-full text-lg">
                    ‚úÖ Uren Opslaan
                </button>
            </div>
        </div>

        <!-- Vandaag geregistreerd -->
        <div class="card p-6">
            <h2 class="text-lg font-bold mb-4">üìÖ Vandaag Geregistreerd</h2>
            <div id="vandaagUren">
                <p class="text-gray-400 text-center py-4">Nog geen uren vandaag</p>
            </div>
        </div>

        <!-- Deze week -->
        <div class="card p-6">
            <h2 class="text-lg font-bold mb-4">üìä Deze Week</h2>
            <div id="weekOverzicht">
                <p class="text-gray-400 text-center py-4">Laden...</p>
            </div>
            <div class="mt-4 pt-4 border-t flex justify-between items-center">
                <span class="font-medium text-gray-700">Totaal deze week:</span>
                <span class="text-xl font-bold text-indigo-600" id="weekTotaal">0</span>
            </div>
        </div>

        <!-- Recente uren -->
        <div class="card p-6">
            <h2 class="text-lg font-bold mb-4">üïê Recente Registraties</h2>
            <div id="recenteUren">
                <p class="text-gray-400 text-center py-4">Laden...</p>
            </div>
        </div>
    </main>

    <script>
        let projecten = [];
        let mijnUren = [];
        let medewerkerNaam = '';

        // Check login
        async function checkLogin() {
            try {
                const res = await fetch('/api/medewerker/status');
                const data = await res.json();
                
                if (!data.loggedIn) {
                    window.location.href = '/medewerker-login.html';
                    return false;
                }
                
                medewerkerNaam = data.naam;
                document.getElementById('welcomeMsg').textContent = `Welkom, ${data.naam}`;
                return true;
            } catch (e) {
                window.location.href = '/medewerker-login.html';
                return false;
            }
        }

        // Load projecten
        async function loadProjecten() {
            try {
                const res = await fetch('/api/medewerker/projecten');
                projecten = await res.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Selecteer project...</option>' +
                    projecten.map(p => `<option value="${p.id}" data-naam="${p.titel || p.klant}">${p.titel || p.klant}${p.adres ? ' - ' + p.adres : ''}</option>`).join('');
            } catch (e) {
                console.error('Fout bij laden projecten:', e);
            }
        }

        // Load mijn uren
        async function loadMijnUren() {
            try {
                const res = await fetch('/api/medewerker/uren');
                mijnUren = await res.json();
                
                renderVandaag();
                renderWeek();
                renderRecent();
            } catch (e) {
                console.error('Fout bij laden uren:', e);
            }
        }

        // Render vandaag
        function renderVandaag() {
            const today = new Date().toISOString().split('T')[0];
            const vandaag = mijnUren.filter(u => u.datum === today);
            
            const container = document.getElementById('vandaagUren');
            
            if (vandaag.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nog geen uren vandaag</p>';
                return;
            }
            
            container.innerHTML = vandaag.map(u => `
                <div class="uren-card bg-gray-50 rounded-lg p-4 mb-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold">${u.projectNaam}</div>
                            <div class="text-sm text-gray-500">${u.begintijd} - ${u.eindtijd} (${u.pauze}m pauze)</div>
                            ${u.notitie ? `<div class="text-sm text-gray-600 mt-1">${u.notitie}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-indigo-600">${u.totaalUren}u</div>
                            <button onclick="deleteUren('${u.id}')" class="text-red-500 text-xs hover:text-red-700">Verwijderen</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render week
        function renderWeek() {
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay() + 1); // Monday
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            const weekUren = mijnUren.filter(u => u.datum >= weekStartStr);
            
            // Group by day
            const perDag = {};
            const dagen = ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'];
            
            weekUren.forEach(u => {
                if (!perDag[u.datum]) perDag[u.datum] = 0;
                perDag[u.datum] += u.totaalUren;
            });
            
            const container = document.getElementById('weekOverzicht');
            const totaal = Object.values(perDag).reduce((s, h) => s + h, 0);
            
            if (Object.keys(perDag).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nog geen uren deze week</p>';
            } else {
                container.innerHTML = Object.entries(perDag)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([datum, uren]) => {
                        const d = new Date(datum);
                        const dag = dagen[d.getDay()];
                        return `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600">${dag} ${d.getDate()}/${d.getMonth()+1}</span>
                                <span class="font-semibold">${uren.toFixed(1)} uur</span>
                            </div>
                        `;
                    }).join('');
            }
            
            document.getElementById('weekTotaal').textContent = totaal.toFixed(1) + ' uur';
        }

        // Render recent
        function renderRecent() {
            const recent = mijnUren.slice(-10).reverse();
            const container = document.getElementById('recenteUren');
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Geen recente uren</p>';
                return;
            }
            
            container.innerHTML = recent.map(u => {
                const d = new Date(u.datum);
                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div>
                            <div class="text-sm font-medium">${u.projectNaam}</div>
                            <div class="text-xs text-gray-500">${d.toLocaleDateString('nl-NL')}</div>
                        </div>
                        <span class="font-semibold text-indigo-600">${u.totaalUren}u</span>
                    </div>
                `;
            }).join('');
        }

        // Calculate totaal preview
        function updateTotaalPreview() {
            const begintijd = document.getElementById('begintijdInput').value;
            const eindtijd = document.getElementById('eindtijdInput').value;
            const pauze = parseInt(document.getElementById('pauzeInput').value) || 0;
            
            if (!begintijd || !eindtijd) {
                document.getElementById('totaalPreview').textContent = '-';
                return;
            }
            
            const begin = new Date(`2000-01-01T${begintijd}`);
            const eind = new Date(`2000-01-01T${eindtijd}`);
            const totaalMin = (eind - begin) / 60000 - pauze;
            const totaalUren = Math.max(0, totaalMin / 60);
            
            document.getElementById('totaalPreview').textContent = totaalUren.toFixed(1);
        }

        // Save uren
        async function saveUren() {
            const projectSelect = document.getElementById('projectSelect');
            const projectId = projectSelect.value;
            const projectNaam = projectSelect.options[projectSelect.selectedIndex]?.dataset?.naam || '';
            const datum = document.getElementById('datumInput').value;
            const begintijd = document.getElementById('begintijdInput').value;
            const eindtijd = document.getElementById('eindtijdInput').value;
            const pauze = document.getElementById('pauzeInput').value;
            const notitie = document.getElementById('notitieInput').value;
            
            if (!projectId || !datum || !begintijd || !eindtijd) {
                alert('Vul alle verplichte velden in');
                return;
            }
            
            try {
                const res = await fetch('/api/medewerker/uren', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId, projectNaam, datum, begintijd, eindtijd, pauze, notitie })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    // Reset form
                    document.getElementById('notitieInput').value = '';
                    document.getElementById('datumInput').value = new Date().toISOString().split('T')[0];
                    
                    // Reload uren
                    await loadMijnUren();
                    
                    alert('‚úÖ Uren opgeslagen!');
                } else {
                    alert(data.error || 'Fout bij opslaan');
                }
            } catch (e) {
                alert('Verbindingsfout');
            }
        }

        // Delete uren
        async function deleteUren(id) {
            if (!confirm('Weet je zeker dat je deze uren wilt verwijderen?')) return;
            
            try {
                const res = await fetch(`/api/medewerker/uren/${id}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (res.ok && data.success) {
                    await loadMijnUren();
                } else {
                    alert(data.error || 'Fout bij verwijderen');
                }
            } catch (e) {
                alert('Verbindingsfout');
            }
        }

        // Logout
        async function logout() {
            await fetch('/api/medewerker/logout', { method: 'POST' });
            window.location.href = '/medewerker-login.html';
        }

        // Init
        async function init() {
            if (await checkLogin()) {
                document.getElementById('datumInput').value = new Date().toISOString().split('T')[0];
                
                // Add event listeners for preview
                document.getElementById('begintijdInput').addEventListener('change', updateTotaalPreview);
                document.getElementById('eindtijdInput').addEventListener('change', updateTotaalPreview);
                document.getElementById('pauzeInput').addEventListener('change', updateTotaalPreview);
                
                await loadProjecten();
                await loadMijnUren();
                updateTotaalPreview();
            }
        }
        
        init();
    </script>
</body>
</html>
