<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Dashboard - StucAdmin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Auth check
        fetch('/api/auth/check').then(r => r.json()).then(d => { if (!d.authenticated) window.location.href = '/login.html'; }).catch(() => window.location.href = '/login.html');
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%); min-height: 100vh; }
        .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--from), var(--to)); border-radius: 20px; padding: 24px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-4px); }
        .stat-value { font-size: 2.5rem; font-weight: 800; }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-glass { background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(8px); }
        .btn-glass:hover { background: rgba(255,255,255,0.25); }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        
        @media (max-width: 768px) {
            .stat-value { font-size: 1.75rem; }
            .stat-card { padding: 16px; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-white">üìä Executive Dashboard</h1>
                <p class="text-indigo-200 mt-2">Management Overzicht - StucAdmin Pro</p>
            </div>
            <div class="flex gap-3 flex-wrap">
                <a href="dashboard.html" class="btn btn-glass">‚Üê Terug</a>
                <button onclick="refreshDashboard()" class="btn btn-primary">üîÑ Refresh</button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
            <div class="stat-card" style="--from: #10b981; --to: #059669;">
                <p class="text-sm opacity-90">üí∞ Besparingspotentieel</p>
                <p class="stat-value mt-2" id="totalSavings">‚Ç¨0</p>
                <p class="text-xs mt-2 opacity-75">op basis van analyse</p>
            </div>
            <div class="stat-card" style="--from: #3b82f6; --to: #2563eb;">
                <p class="text-sm opacity-90">üìà Totale Inkoop</p>
                <p class="stat-value mt-2" id="totalCost">‚Ç¨0</p>
                <p class="text-xs mt-2 opacity-75">afgelopen periode</p>
            </div>
            <div class="stat-card" style="--from: #ef4444; --to: #dc2626;">
                <p class="text-sm opacity-90">‚ö†Ô∏è Prijs Alerts</p>
                <p class="stat-value mt-2" id="alertCount">0</p>
                <p class="text-xs mt-2 opacity-75">vereisen aandacht</p>
            </div>
            <div class="stat-card" style="--from: #8b5cf6; --to: #7c3aed;">
                <p class="text-sm opacity-90">üìÑ Facturen</p>
                <p class="stat-value mt-2" id="invoiceCount">0</p>
                <p class="text-xs mt-2 opacity-75">geanalyseerd</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">üìä Inkoop per Maand</h3>
                <div class="h-64"><canvas id="monthlyChart"></canvas></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">üèÜ Top 5 Leveranciers</h3>
                <div class="h-64"><canvas id="suppliersChart"></canvas></div>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card p-6 lg:col-span-2">
                <h3 class="text-xl font-bold text-white mb-4">üìà Kosten Trend</h3>
                <div class="h-48"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">‚ö° Quick Stats</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-white">
                        <span class="opacity-75">Gem. per factuur</span>
                        <span class="font-bold" id="avgInvoice">‚Ç¨0</span>
                    </div>
                    <div class="flex justify-between items-center text-white">
                        <span class="opacity-75">Hoogste factuur</span>
                        <span class="font-bold" id="maxInvoice">‚Ç¨0</span>
                    </div>
                    <div class="flex justify-between items-center text-white">
                        <span class="opacity-75">Leveranciers</span>
                        <span class="font-bold" id="supplierCount">0</span>
                    </div>
                    <div class="flex justify-between items-center text-white">
                        <span class="opacity-75">Deze maand</span>
                        <span class="font-bold" id="thisMonth">‚Ç¨0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-indigo-300 text-sm">
            StucAdmin Pro - Executive Dashboard
        </div>
    </div>

    <script>
        let charts = {};

        async function refreshDashboard() {
            try {
                // Haal inkoopfacturen op (relatieve URL - werkt op localhost EN productie)
                const purchaseRes = await fetch('/api/purchase_invoices');
                const purchases = await purchaseRes.json();
                
                // Bereken statistieken
                const totalCost = purchases.reduce((sum, p) => sum + parseFloat(p.total_price_incl_tax || 0), 0);
                const avgInvoice = purchases.length > 0 ? totalCost / purchases.length : 0;
                const maxInvoice = Math.max(...purchases.map(p => parseFloat(p.total_price_incl_tax || 0)), 0);
                
                // Tel unieke leveranciers
                const suppliers = {};
                purchases.forEach(p => {
                    const name = p.contact?.company_name || 'Onbekend';
                    if (!suppliers[name]) suppliers[name] = 0;
                    suppliers[name] += parseFloat(p.total_price_incl_tax || 0);
                });
                
                // Deze maand
                const now = new Date();
                const thisMonthPurchases = purchases.filter(p => {
                    const d = new Date(p.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const thisMonthTotal = thisMonthPurchases.reduce((sum, p) => sum + parseFloat(p.total_price_incl_tax || 0), 0);
                
                // Bereken potenti√´le besparing (schatting: 5% van totaal)
                const potentialSavings = totalCost * 0.05;
                
                // Alerts tellen (facturen boven ‚Ç¨500 als voorbeeld)
                const alerts = purchases.filter(p => parseFloat(p.total_price_incl_tax || 0) > 500).length;
                
                // Update KPIs
                document.getElementById('totalSavings').textContent = '‚Ç¨' + potentialSavings.toLocaleString('nl-NL', {maximumFractionDigits: 0});
                document.getElementById('totalCost').textContent = '‚Ç¨' + totalCost.toLocaleString('nl-NL', {maximumFractionDigits: 0});
                document.getElementById('alertCount').textContent = alerts;
                document.getElementById('invoiceCount').textContent = purchases.length;
                document.getElementById('avgInvoice').textContent = '‚Ç¨' + avgInvoice.toLocaleString('nl-NL', {maximumFractionDigits: 0});
                document.getElementById('maxInvoice').textContent = '‚Ç¨' + maxInvoice.toLocaleString('nl-NL', {maximumFractionDigits: 0});
                document.getElementById('supplierCount').textContent = Object.keys(suppliers).length;
                document.getElementById('thisMonth').textContent = '‚Ç¨' + thisMonthTotal.toLocaleString('nl-NL', {maximumFractionDigits: 0});
                
                // Render charts
                renderCharts(purchases, suppliers);
                
            } catch (error) {
                console.error('Dashboard refresh failed:', error);
            }
        }

        function renderCharts(purchases, suppliers) {
            // Destroy existing charts
            Object.values(charts).forEach(c => c?.destroy());
            
            const months = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            const year = new Date().getFullYear();
            
            // Monthly data
            const monthlyData = months.map((m, i) => {
                return purchases.filter(p => {
                    const d = new Date(p.date);
                    return d.getMonth() === i && d.getFullYear() === year;
                }).reduce((sum, p) => sum + parseFloat(p.total_price_incl_tax || 0), 0);
            });

            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Inkoop',
                        data: monthlyData,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#fff', callback: v => '‚Ç¨' + v.toLocaleString() },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Top suppliers
            const topSuppliers = Object.entries(suppliers)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const suppliersCtx = document.getElementById('suppliersChart').getContext('2d');
            charts.suppliers = new Chart(suppliersCtx, {
                type: 'doughnut',
                data: {
                    labels: topSuppliers.map(s => s[0].substring(0, 15)),
                    datasets: [{
                        data: topSuppliers.map(s => s[1]),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#fff', boxWidth: 12, font: { size: 11 } }
                        }
                    }
                }
            });

            // Trend Chart (last 6 months)
            const last6Months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                last6Months.push({
                    label: months[d.getMonth()],
                    month: d.getMonth(),
                    year: d.getFullYear()
                });
            }

            const trendData = last6Months.map(m => {
                return purchases.filter(p => {
                    const d = new Date(p.date);
                    return d.getMonth() === m.month && d.getFullYear() === m.year;
                }).reduce((sum, p) => sum + parseFloat(p.total_price_incl_tax || 0), 0);
            });

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: last6Months.map(m => m.label),
                    datasets: [{
                        label: 'Kosten',
                        data: trendData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff', callback: v => '‚Ç¨' + v.toLocaleString() },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Load on page load
        window.onload = refreshDashboard;
    </script>
<script src="/data-sync.js"></script>
</body>
</html>
