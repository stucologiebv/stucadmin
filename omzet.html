<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omzet - StucAdmin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="/sidebar.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #f5f7fa; }
        .mobile-menu-btn { display: none; position: fixed; top: 12px; left: 12px; z-index: 200; background: #6366f1; color: white; border: none; border-radius: 10px; width: 44px; height: 44px; font-size: 20px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; }
        .kpi-card { position: relative; overflow: hidden; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--accent, #6366f1); }
        .kpi-value { font-size: 1.75rem; font-weight: 800; color: var(--accent, #6366f1); }
        .btn-secondary { background: #f1f5f9; color: #475569; padding: 8px 16px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
        .data-table { width: 100%; }
        .data-table th { text-align: left; padding: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #94a3b8; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        main { padding: 24px; min-height: 100vh; }
        @media (max-width: 1024px) {
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            main { margin-left: 0 !important; padding: 70px 12px 24px 12px; }
            .kpi-value { font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
    <div class="sidebar-overlay" onclick="toggleMenu()"></div>
    
    <div class="flex min-h-screen">
        <main class="flex-1">
            <header class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <div><h1 class="text-lg sm:text-xl font-bold">ðŸ’¹ Omzet & Facturen</h1><p class="text-gray-500 text-sm">Financieel overzicht</p></div>
                <div class="flex gap-2">
                    <select id="jaar" class="btn-secondary" onchange="loadData()"></select>
                    <button onclick="location.reload()" class="btn-secondary">ðŸ”„</button>
                </div>
            </header>

            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-100 rounded-xl p-3 mb-4 flex items-center gap-3">
                <span class="text-xl">ðŸ’°</span>
                <p class="text-sm text-emerald-700"><strong>Automatische sync</strong> â€” Alle facturen worden realtime gesynchroniseerd met je boekhouding.</p>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                <div class="card kpi-card p-4" style="--accent: #10b981"><p class="text-gray-500 text-xs">Jaar omzet</p><p class="kpi-value" id="kpiJaar">â‚¬0</p></div>
                <div class="card kpi-card p-4" style="--accent: #3b82f6"><p class="text-gray-500 text-xs">Deze maand</p><p class="kpi-value" id="kpiMaand">â‚¬0</p></div>
                <div class="card kpi-card p-4" style="--accent: #f59e0b"><p class="text-gray-500 text-xs">Openstaand</p><p class="kpi-value" id="kpiOpen">â‚¬0</p></div>
                <div class="card kpi-card p-4" style="--accent: #8b5cf6"><p class="text-gray-500 text-xs">Betaald</p><p class="kpi-value" id="kpiBetaald">â‚¬0</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card p-4"><h2 class="font-bold mb-4 text-sm">ðŸ“ˆ Omzet per maand</h2><div class="h-48"><canvas id="omzetChart"></canvas></div></div>
                <div class="card p-4"><h2 class="font-bold mb-4 text-sm">ðŸ“Š Status verdeling</h2><div class="h-48"><canvas id="statusChart"></canvas></div></div>
            </div>

            <div class="card p-4">
                <h2 class="font-bold mb-4 text-sm">ðŸ“„ Alle facturen</h2>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead><tr><th>Nr</th><th>Klant</th><th>Datum</th><th>Bedrag</th><th>Status</th></tr></thead>
                        <tbody id="facturenTabel"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { showToast, showLoading } from '/public/js/modules/ui.js';

        // XSS protection
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return DOMPurify.sanitize(String(str));
        }

        // Auth check
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/check', { credentials: 'include' });
                const data = await res.json();
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                    return false;
                }
                return true;
            } catch {
                window.location.href = '/login.html';
                return false;
            }
        }

        let invoices = [], contacts = [];
        let omzetChartInstance = null, statusChartInstance = null;

        function toggleMenu() {
            document.querySelector('.sidebar')?.classList.toggle('open');
            document.querySelector('.sidebar-overlay')?.classList.toggle('open');
        }
        window.toggleMenu = toggleMenu;

        async function loadData() {
            document.getElementById('kpiJaar').textContent = '...';
            document.getElementById('kpiMaand').textContent = '...';
            document.getElementById('kpiOpen').textContent = '...';
            document.getElementById('kpiBetaald').textContent = '...';
            document.getElementById('facturenTabel').innerHTML = '<tr><td colspan="5" class="text-center text-gray-400 py-8">Laden...</td></tr>';
            
            try {
                [invoices, contacts] = await Promise.all([
                    fetch('/api/invoices', { credentials: 'include' }).then(r => r.json()),
                    fetch('/api/contacts', { credentials: 'include' }).then(r => r.json())
                ]);
                renderAll();
            } catch (e) {
                console.error(e);
                showToast('Fout bij laden facturen', 'error');
            }
        }
        window.loadData = loadData;

        function renderAll() {
            const jaar = parseInt(document.getElementById('jaar').value);
            const jaarInv = invoices.filter(i => {
                const dateStr = i.invoice_date || i.created_at;
                if (!dateStr) return false;
                return new Date(dateStr).getFullYear() === jaar;
            });
            const now = new Date();
            const maandInv = jaarInv.filter(i => {
                const dateStr = i.invoice_date || i.created_at;
                return new Date(dateStr).getMonth() === now.getMonth();
            });
            
            const realInvoices = jaarInv.filter(i => i.state !== 'draft');
            const jaarOmzet = realInvoices.reduce((s, i) => s + parseFloat(i.total_price_incl_tax || 0), 0);
            const maandRealInv = maandInv.filter(i => i.state !== 'draft');
            const maandOmzet = maandRealInv.reduce((s, i) => s + parseFloat(i.total_price_incl_tax || 0), 0);
            const open = jaarInv.filter(i => i.state === 'open' || i.state === 'late' || i.state === 'reminded');
            const betaald = jaarInv.filter(i => i.state === 'paid');
            
            document.getElementById('kpiJaar').textContent = 'â‚¬' + jaarOmzet.toLocaleString('nl-NL', {maximumFractionDigits: 0});
            document.getElementById('kpiMaand').textContent = 'â‚¬' + maandOmzet.toLocaleString('nl-NL', {maximumFractionDigits: 0});
            document.getElementById('kpiOpen').textContent = 'â‚¬' + open.reduce((s, i) => s + parseFloat(i.total_price_incl_tax || 0), 0).toLocaleString('nl-NL', {maximumFractionDigits: 0});
            document.getElementById('kpiBetaald').textContent = 'â‚¬' + betaald.reduce((s, i) => s + parseFloat(i.total_price_incl_tax || 0), 0).toLocaleString('nl-NL', {maximumFractionDigits: 0});

            renderCharts(jaarInv);
            renderTabel(jaarInv);
        }

        function renderCharts(jaarInv) {
            const months = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
            const maandData = months.map((m, i) => {
                return jaarInv.filter(inv => {
                    if (inv.state === 'draft') return false;
                    const dateStr = inv.invoice_date || inv.created_at;
                    return new Date(dateStr).getMonth() === i;
                }).reduce((s, inv) => s + parseFloat(inv.total_price_incl_tax || 0), 0);
            });

            if (omzetChartInstance) omzetChartInstance.destroy();
            if (statusChartInstance) statusChartInstance.destroy();

            omzetChartInstance = new Chart(document.getElementById('omzetChart'), {
                type: 'bar',
                data: { labels: months, datasets: [{ data: maandData, backgroundColor: '#6366f1', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'â‚¬' + v.toLocaleString() } } } }
            });

            const statusData = [
                jaarInv.filter(i => i.state === 'paid').length,
                jaarInv.filter(i => i.state === 'open' || i.state === 'late' || i.state === 'reminded').length,
                jaarInv.filter(i => i.state === 'draft').length
            ];
            statusChartInstance = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: { labels: ['Betaald', 'Open', 'Concept'], datasets: [{ data: statusData, backgroundColor: ['#10b981', '#f59e0b', '#94a3b8'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderTabel(jaarInv) {
            const rows = jaarInv.sort((a, b) => {
                const dateA = a.invoice_date || a.created_at;
                const dateB = b.invoice_date || b.created_at;
                return new Date(dateB) - new Date(dateA);
            }).map(inv => {
                const c = contacts.find(x => x.id === inv.contact_id);
                const dateStr = inv.invoice_date || inv.created_at;
                const dateDisplay = dateStr ? new Date(dateStr).toLocaleDateString('nl-NL') : '-';
                
                // Escaped values for XSS protection
                const invoiceId = escapeHTML(inv.invoice_id || '-');
                const klantNaam = escapeHTML(c?.company_name || c?.firstname || inv.contact?.company_name || '-');
                const bedrag = parseFloat(inv.total_price_incl_tax || 0).toFixed(0);
                
                const statusMap = {
                    'paid': '<span class="text-green-600">Betaald</span>',
                    'late': '<span class="text-red-500">Te laat</span>',
                    'reminded': '<span class="text-orange-600">Herinnerd</span>',
                    'open': '<span class="text-orange-500">Open</span>'
                };
                const status = statusMap[inv.state] || '<span class="text-gray-400">Concept</span>';
                
                return `<tr>
                    <td class="font-medium">${invoiceId}</td>
                    <td>${klantNaam}</td>
                    <td>${dateDisplay}</td>
                    <td class="font-semibold">â‚¬${bedrag}</td>
                    <td>${status}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('facturenTabel').innerHTML = rows || '<tr><td colspan="5" class="text-center text-gray-400 py-8">Geen facturen</td></tr>';
        }

        async function init() {
            showLoading(true);
            if (!await checkAuth()) return;
            
            const jaarSelect = document.getElementById('jaar');
            const huidigJaar = new Date().getFullYear();
            for (let j = huidigJaar; j >= huidigJaar - 3; j--) {
                jaarSelect.innerHTML += `<option value="${j}">${j}</option>`;
            }
            await loadData();
            showLoading(false);
        }

        init();
    </script>
    <script src="/data-sync.js"></script>
</body>
</html>
