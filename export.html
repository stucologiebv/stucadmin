<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export & Rapportages - StucAdmin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
        .sidebar { width: 250px; background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%); min-height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; }
        .sidebar.closed { transform: translateX(-250px); }
        .main-content { margin-left: 250px; padding: 24px; min-height: 100vh; transition: margin-left 0.3s; }
        .main-content.expanded { margin-left: 0; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .btn-secondary { background: #f1f5f9; color: #475569; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { background: #e2e8f0; }
        .form-select, .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .form-select:focus, .form-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.1); }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s; }
        .checkbox-label:hover { background: #f8fafc; }
        .checkbox-label input { width: 18px; height: 18px; accent-color: #8b5cf6; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .preview-table th { background: #f8fafc; padding: 10px 12px; text-align: left; font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        .preview-table td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        .preview-table tr:hover { background: #fafafa; }
        .totaal-row { background: #f0fdf4 !important; font-weight: 600; }
        .totaal-row td { border-top: 2px solid #22c55e; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-zzp { background: #f3e8ff; color: #7c3aed; }
        .badge-vast { background: #dbeafe; color: #2563eb; }
        .loading { display: none; align-items: center; justify-content: center; padding: 40px; }
        .loading.active { display: flex; }
        .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-250px); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
        }
    </style>
</head>
<body>
    <div id="sidebarContainer"></div>
    
    <main class="main-content" id="mainContent">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">üì• Export & Rapportages</h1>
                <p class="text-gray-500 text-sm">Genereer urenstaten voor facturatie</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Filter panel -->
            <div class="lg:col-span-1">
                <div class="card p-5">
                    <h2 class="font-bold text-gray-800 mb-4">üîç Filter</h2>
                    
                    <!-- Opdrachtgever -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Opdrachtgever</label>
                        <select id="filterKlant" class="form-select" onchange="onKlantChange()">
                            <option value="">Alle opdrachtgevers</option>
                        </select>
                    </div>
                    
                    <!-- Project/Locatie -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project / Locatie</label>
                        <select id="filterProject" class="form-select" onchange="loadPreview()">
                            <option value="">Alle projecten</option>
                        </select>
                    </div>
                    
                    <!-- Periode -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periode</label>
                        <select id="filterPeriode" class="form-select" onchange="onPeriodeChange()">
                            <option value="week">Deze week</option>
                            <option value="vorige_week">Vorige week</option>
                            <option value="maand">Deze maand</option>
                            <option value="vorige_maand">Vorige maand</option>
                            <option value="custom">Aangepast...</option>
                        </select>
                    </div>
                    
                    <!-- Custom datum range -->
                    <div id="customDates" class="mb-4 hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Van</label>
                                <input type="date" id="filterVan" class="form-input" onchange="loadPreview()">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Tot</label>
                                <input type="date" id="filterTot" class="form-input" onchange="loadPreview()">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-gray-200">
                    
                    <!-- Inhoud opties -->
                    <h3 class="font-medium text-gray-700 mb-3">Inhoud</h3>
                    <div class="space-y-2 mb-4">
                        <label class="checkbox-label">
                            <input type="checkbox" id="inclUren" checked onchange="loadPreview()">
                            <span>‚è±Ô∏è Uren per medewerker</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="inclBonnen" checked onchange="loadPreview()">
                            <span>üßæ Materialen / bonnen</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="inclReiskosten" checked onchange="loadPreview()">
                            <span>üöó Reiskosten</span>
                        </label>
                    </div>
                    
                    <hr class="my-4 border-gray-200">
                    
                    <!-- Verkooptarief -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Verkooptarief <span class="text-gray-400 text-xs">(aan klant)</span></label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">‚Ç¨</span>
                            <input type="number" id="uurtarief" value="60" step="0.01" min="0" 
                                   class="form-input pl-8" onchange="loadPreview()">
                        </div>
                    </div>
                    
                    <!-- Export knoppen -->
                    <div class="space-y-3">
                        <button onclick="exportPDF()" class="btn-primary w-full flex items-center justify-center gap-2">
                            <span>üìÑ</span> Download PDF
                        </button>
                        <button onclick="exportExcel()" class="btn-secondary w-full flex items-center justify-center gap-2">
                            <span>üìä</span> Download Excel
                        </button>
                        <button onclick="exportToMoneybird()" class="w-full flex items-center justify-center gap-2 text-white font-semibold py-2.5 px-4 rounded-lg transition-all"
                                style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);"
                                onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(37,99,235,0.4)'"
                                onmouseout="this.style.transform='';this.style.boxShadow=''">
                            <span>üì§</span> Naar Moneybird (concept)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Preview panel -->
            <div class="lg:col-span-2">
                <div class="card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold text-gray-800">üìã Preview</h2>
                        <span id="previewPeriode" class="text-sm text-gray-500"></span>
                    </div>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <span class="ml-3 text-gray-500">Laden...</span>
                    </div>
                    
                    <div id="previewEmpty" class="text-center py-12 text-gray-400">
                        <span class="text-4xl block mb-2">üìã</span>
                        <p>Selecteer filters om preview te zien</p>
                    </div>
                    
                    <div id="previewContent" class="hidden">
                        <!-- Uren tabel -->
                        <div id="urenSection" class="mb-6">
                            <h3 class="font-semibold text-gray-700 mb-3">‚è±Ô∏è Uren</h3>
                            <div class="overflow-x-auto">
                                <table class="preview-table" id="urenTable">
                                    <thead>
                                        <tr>
                                            <th>Datum</th>
                                            <th>Medewerker</th>
                                            <th>Locatie</th>
                                            <th class="text-right">Begin</th>
                                            <th class="text-right">Eind</th>
                                            <th class="text-right">Pauze</th>
                                            <th class="text-right">Uren</th>
                                        </tr>
                                    </thead>
                                    <tbody id="urenTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Bonnen tabel -->
                        <div id="bonnenSection" class="mb-6 hidden">
                            <h3 class="font-semibold text-gray-700 mb-3">üßæ Materialen / Bonnen</h3>
                            <div class="overflow-x-auto">
                                <table class="preview-table" id="bonnenTable">
                                    <thead>
                                        <tr>
                                            <th>Datum</th>
                                            <th>Medewerker</th>
                                            <th>Winkel</th>
                                            <th>Categorie</th>
                                            <th class="text-right">Bedrag</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bonnenTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Reiskosten tabel -->
                        <div id="reiskostenSection" class="mb-6 hidden">
                            <h3 class="font-semibold text-gray-700 mb-3">üöó Reiskosten</h3>
                            <div class="overflow-x-auto">
                                <table class="preview-table" id="reiskostenTable">
                                    <thead>
                                        <tr>
                                            <th>Datum</th>
                                            <th>Medewerker</th>
                                            <th>Omschrijving</th>
                                            <th class="text-right">KM</th>
                                            <th class="text-right">Bedrag</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reiskostenTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Totalen -->
                        <div id="totalenSection" class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-gray-700 mb-3">üìä Totalen</h3>
                            <div class="grid grid-cols-4 gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-purple-600" id="totaalUren">0</p>
                                    <p class="text-sm text-gray-500">Uren</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-600" id="totaalBonnen">‚Ç¨0</p>
                                    <p class="text-sm text-gray-500">Materialen</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-blue-600" id="totaalReiskosten">‚Ç¨0</p>
                                    <p class="text-sm text-gray-500">Reiskosten</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-orange-600" id="totaalFactuur">‚Ç¨0</p>
                                    <p class="text-sm text-gray-500">Factuurbedrag</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Marge per medewerker -->
                        <div id="margeSection" class="mb-4">
                            <h3 class="font-semibold text-gray-700 mb-3">üí∞ Marge per medewerker</h3>
                            <div class="overflow-x-auto">
                                <table class="preview-table" id="margeTable">
                                    <thead>
                                        <tr>
                                            <th>Medewerker</th>
                                            <th class="text-right">Uren</th>
                                            <th class="text-right">Omzet</th>
                                            <th class="text-right">Kosten</th>
                                            <th class="text-right">Marge</th>
                                            <th class="text-right">Marge %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="margeTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/sidebar.js"></script>
    <script>

        // XSS Protection - escape HTML special characters
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return str.replace(/[&<>"']/g, m => map[m]);
        }
        // Data
        let uren = [];
        let projecten = [];
        let klanten = [];
        let filteredData = { uren: [], bonnen: [], reiskosten: [] };
        
        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            setDefaultDates();
            loadPreview();
        });
        
        let medewerkers = [];
        let zzpers = [];
        
        async function loadData() {
            try {
                // Laad uren
                const urenRes = await fetch('/api/uren');
                if (urenRes.ok) uren = await urenRes.json();
                
                // Laad projecten
                const projRes = await fetch('/api/projecten');
                if (projRes.ok) projecten = await projRes.json();
                
                // Laad medewerkers voor kostprijs
                const medRes = await fetch('/api/medewerkers');
                if (medRes.ok) medewerkers = await medRes.json();
                
                // Laad ZZP'ers voor kostprijs
                const zzpRes = await fetch('/api/zzpers');
                if (zzpRes.ok) zzpers = await zzpRes.json();
                
                // Bouw klanten lijst uit projecten en uren
                buildKlantenList();
                populateFilters();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        function getKostprijs(medewerkerId) {
            // Zoek in medewerkers
            const med = medewerkers.find(m => m.id === medewerkerId);
            if (med && med.uurtarief) return parseFloat(med.uurtarief);
            
            // Zoek in ZZP'ers
            const zzp = zzpers.find(z => z.id === medewerkerId);
            if (zzp && zzp.uurtarief) return parseFloat(zzp.uurtarief);
            
            return 0; // Geen kostprijs bekend
        }
        
        function buildKlantenList() {
            const klantMap = new Map();
            
            // Uit projecten
            projecten.forEach(p => {
                if (p.klantId && p.klantNaam) {
                    klantMap.set(p.klantId, { id: p.klantId, naam: p.klantNaam });
                } else if (p.klant?.naam) {
                    const id = p.contactId || p.klant.id || 'k_' + p.klant.naam;
                    klantMap.set(id, { id, naam: p.klant.naam });
                }
            });
            
            // Uit uren
            uren.forEach(u => {
                if (u.klantId && u.klantNaam) {
                    klantMap.set(u.klantId, { id: u.klantId, naam: u.klantNaam });
                }
            });
            
            klanten = Array.from(klantMap.values()).sort((a, b) => a.naam.localeCompare(b.naam));
        }
        
        function populateFilters() {
            // Klanten dropdown
            const klantSelect = document.getElementById('filterKlant');
            klantSelect.innerHTML = '<option value="">Alle opdrachtgevers</option>';
            klanten.forEach(k => {
                klantSelect.innerHTML += `<option value="${k.id}">${escapeHtml(k.naam)}</option>`;
            });
            
            // Projecten dropdown
            populateProjecten();
        }
        
        function populateProjecten(klantId = null) {
            const projectSelect = document.getElementById('filterProject');
            projectSelect.innerHTML = '<option value="">Alle projecten</option>';
            
            // Unieke locaties uit projecten en uren
            const locaties = new Map();
            
            projecten.forEach(p => {
                if (klantId && p.klantId !== klantId && p.contactId !== klantId) return;
                const loc = p.locatie || p.adres;
                if (loc) {
                    locaties.set(loc, { 
                        id: p.id, 
                        naam: p.titel || p.naam || loc,
                        locatie: loc 
                    });
                }
            });
            
            // Ook locaties uit uren die niet in projecten zitten
            uren.forEach(u => {
                if (klantId && u.klantId !== klantId) return;
                if (u.locatieAdres && !locaties.has(u.locatieAdres)) {
                    locaties.set(u.locatieAdres, {
                        id: 'loc_' + u.locatieAdres,
                        naam: u.locatieAdres,
                        locatie: u.locatieAdres
                    });
                }
            });
            
            Array.from(locaties.values())
                .sort((a, b) => a.naam.localeCompare(b.naam))
                .forEach(p => {
                    projectSelect.innerHTML += `<option value="${escapeHtml(p.locatie)}">${escapeHtml(p.naam)}</option>`;
                });
        }
        
        function onKlantChange() {
            const klantId = document.getElementById('filterKlant').value;
            populateProjecten(klantId);
            loadPreview();
        }
        
        function setDefaultDates() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            document.getElementById('filterVan').value = formatDate(monday);
            document.getElementById('filterTot').value = formatDate(sunday);
        }
        
        function onPeriodeChange() {
            const periode = document.getElementById('filterPeriode').value;
            const customDates = document.getElementById('customDates');
            
            if (periode === 'custom') {
                customDates.classList.remove('hidden');
            } else {
                customDates.classList.add('hidden');
                
                const now = new Date();
                let van, tot;
                
                if (periode === 'week') {
                    const dayOfWeek = now.getDay();
                    van = new Date(now);
                    van.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    tot = new Date(van);
                    tot.setDate(van.getDate() + 6);
                } else if (periode === 'vorige_week') {
                    const dayOfWeek = now.getDay();
                    van = new Date(now);
                    van.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) - 7);
                    tot = new Date(van);
                    tot.setDate(van.getDate() + 6);
                } else if (periode === 'maand') {
                    van = new Date(now.getFullYear(), now.getMonth(), 1);
                    tot = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (periode === 'vorige_maand') {
                    van = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    tot = new Date(now.getFullYear(), now.getMonth(), 0);
                }
                
                document.getElementById('filterVan').value = formatDate(van);
                document.getElementById('filterTot').value = formatDate(tot);
            }
            
            loadPreview();
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function loadPreview() {
            const klantId = document.getElementById('filterKlant').value;
            const locatie = document.getElementById('filterProject').value;
            const van = document.getElementById('filterVan').value;
            const tot = document.getElementById('filterTot').value;
            const inclUren = document.getElementById('inclUren').checked;
            const inclBonnen = document.getElementById('inclBonnen').checked;
            const inclReiskosten = document.getElementById('inclReiskosten').checked;
            
            // Filter uren
            let filtered = uren.filter(u => {
                if (van && u.datum < van) return false;
                if (tot && u.datum > tot) return false;
                if (klantId && u.klantId !== klantId) return false;
                if (locatie && u.locatieAdres !== locatie) return false;
                return true;
            });
            
            // Sort by date
            filtered.sort((a, b) => a.datum.localeCompare(b.datum));
            
            // Extract data
            filteredData.uren = filtered;
            filteredData.bonnen = [];
            filteredData.reiskosten = [];
            
            filtered.forEach(u => {
                if (u.bonnen && u.bonnen.length) {
                    u.bonnen.forEach(b => {
                        filteredData.bonnen.push({
                            ...b,
                            datum: u.datum,
                            medewerkerNaam: u.medewerkerNaam
                        });
                    });
                }
                if (u.reiskosten && u.reiskosten.km > 0) {
                    filteredData.reiskosten.push({
                        ...u.reiskosten,
                        datum: u.datum,
                        medewerkerNaam: u.medewerkerNaam
                    });
                }
            });
            
            // Update preview
            renderPreview(inclUren, inclBonnen, inclReiskosten);
            updatePeriodeLabel(van, tot);
        }
        function renderPreview(inclUren, inclBonnen, inclReiskosten) {
            const previewEmpty = document.getElementById('previewEmpty');
            const previewContent = document.getElementById('previewContent');
            
            if (filteredData.uren.length === 0) {
                previewEmpty.classList.remove('hidden');
                previewContent.classList.add('hidden');
                return;
            }
            
            previewEmpty.classList.add('hidden');
            previewContent.classList.remove('hidden');
            
            // Uren
            const urenSection = document.getElementById('urenSection');
            const urenBody = document.getElementById('urenTableBody');
            if (inclUren && filteredData.uren.length) {
                urenSection.classList.remove('hidden');
                let totaalUren = 0;
                urenBody.innerHTML = filteredData.uren.map(u => {
                    totaalUren += u.totaalUren || 0;
                    return `<tr>
                        <td>${formatDatum(u.datum)}</td>
                        <td>${u.medewerkerNaam || '-'}</td>
                        <td>${(u.locatieAdres || '-').substring(0, 30)}</td>
                        <td class="text-right">${u.begintijd}</td>
                        <td class="text-right">${u.eindtijd}</td>
                        <td class="text-right">${u.pauze || 0} min</td>
                        <td class="text-right font-semibold">${(u.totaalUren || 0).toFixed(2)}</td>
                    </tr>`;
                }).join('');
                urenBody.innerHTML += `<tr class="totaal-row">
                    <td colspan="6" class="text-right font-bold">Totaal uren:</td>
                    <td class="text-right font-bold">${totaalUren.toFixed(2)}</td>
                </tr>`;
                document.getElementById('totaalUren').textContent = totaalUren.toFixed(2);
            } else {
                urenSection.classList.add('hidden');
                document.getElementById('totaalUren').textContent = '0';
            }
            
            // Bonnen
            const bonnenSection = document.getElementById('bonnenSection');
            const bonnenBody = document.getElementById('bonnenTableBody');
            if (inclBonnen && filteredData.bonnen.length) {
                bonnenSection.classList.remove('hidden');
                let totaalBonnen = 0;
                bonnenBody.innerHTML = filteredData.bonnen.map(b => {
                    totaalBonnen += b.bedrag || 0;
                    return `<tr>
                        <td>${formatDatum(b.datum)}</td>
                        <td>${b.medewerkerNaam || '-'}</td>
                        <td>${b.winkel || '-'}</td>
                        <td>${b.categorie || '-'}</td>
                        <td class="text-right font-semibold">‚Ç¨${(b.bedrag || 0).toFixed(2)}</td>
                    </tr>`;
                }).join('');
                bonnenBody.innerHTML += `<tr class="totaal-row">
                    <td colspan="4" class="text-right font-bold">Totaal materialen:</td>
                    <td class="text-right font-bold">‚Ç¨${totaalBonnen.toFixed(2)}</td>
                </tr>`;
                document.getElementById('totaalBonnen').textContent = '‚Ç¨' + totaalBonnen.toFixed(2);
            } else {
                bonnenSection.classList.add('hidden');
                document.getElementById('totaalBonnen').textContent = '‚Ç¨0';
            }
            
            // Reiskosten
            const reiskostenSection = document.getElementById('reiskostenSection');
            const reiskostenBody = document.getElementById('reiskostenTableBody');
            if (inclReiskosten && filteredData.reiskosten.length) {
                reiskostenSection.classList.remove('hidden');
                let totaalKm = 0, totaalBedrag = 0;
                reiskostenBody.innerHTML = filteredData.reiskosten.map(r => {
                    totaalKm += r.km || 0;
                    totaalBedrag += r.totaal || 0;
                    return `<tr>
                        <td>${formatDatum(r.datum)}</td>
                        <td>${r.medewerkerNaam || '-'}</td>
                        <td>${r.desc || '-'}</td>
                        <td class="text-right">${r.km || 0} km</td>
                        <td class="text-right font-semibold">‚Ç¨${(r.totaal || 0).toFixed(2)}</td>
                    </tr>`;
                }).join('');
                reiskostenBody.innerHTML += `<tr class="totaal-row">
                    <td colspan="3" class="text-right font-bold">Totaal reiskosten:</td>
                    <td class="text-right font-bold">${totaalKm} km</td>
                    <td class="text-right font-bold">‚Ç¨${totaalBedrag.toFixed(2)}</td>
                </tr>`;
                document.getElementById('totaalReiskosten').textContent = '‚Ç¨' + totaalBedrag.toFixed(2);
            } else {
                reiskostenSection.classList.add('hidden');
                document.getElementById('totaalReiskosten').textContent = '‚Ç¨0';
            }
            
            // Bereken factuurbedrag
            const verkooptarief = parseFloat(document.getElementById('uurtarief').value) || 60;
            const totaalUrenNum = filteredData.uren.reduce((sum, u) => sum + (u.totaalUren || 0), 0);
            const totaalBonnenNum = filteredData.bonnen.reduce((sum, b) => sum + (b.bedrag || 0), 0);
            const totaalReiskostenNum = filteredData.reiskosten.reduce((sum, r) => sum + (r.totaal || 0), 0);
            const factuurBedrag = (totaalUrenNum * verkooptarief) + totaalBonnenNum + totaalReiskostenNum;
            document.getElementById('totaalFactuur').textContent = '‚Ç¨' + factuurBedrag.toFixed(2);
            
            // Render marge tabel
            renderMargeTable(verkooptarief);
        }
        
        function renderMargeTable(verkooptarief) {
            const margeBody = document.getElementById('margeTableBody');
            
            // Groepeer uren per medewerker
            const perMedewerker = {};
            filteredData.uren.forEach(u => {
                const id = u.medewerkerId || 'onbekend';
                const naam = u.medewerkerNaam || 'Onbekend';
                if (!perMedewerker[id]) {
                    perMedewerker[id] = { naam, uren: 0, kostprijs: getKostprijs(id) };
                }
                perMedewerker[id].uren += u.totaalUren || 0;
            });
            
            if (Object.keys(perMedewerker).length === 0) {
                margeBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-4">Geen data</td></tr>';
                return;
            }
            
            let totaalUren = 0, totaalOmzet = 0, totaalKosten = 0, totaalMarge = 0;
            
            margeBody.innerHTML = Object.entries(perMedewerker).map(([id, data]) => {
                const omzet = data.uren * verkooptarief;
                const kosten = data.uren * data.kostprijs;
                const marge = omzet - kosten;
                const margePerc = omzet > 0 ? (marge / omzet * 100) : 0;
                
                totaalUren += data.uren;
                totaalOmzet += omzet;
                totaalKosten += kosten;
                totaalMarge += marge;
                
                const kostprijsKnown = data.kostprijs > 0;
                
                return `<tr>
                    <td>${escapeHtml(data.naam)}</td>
                    <td class="text-right">${data.uren.toFixed(2)}</td>
                    <td class="text-right">‚Ç¨${omzet.toFixed(2)}</td>
                    <td class="text-right ${kostprijsKnown ? '' : 'text-amber-500'}">${kostprijsKnown ? '‚Ç¨' + kosten.toFixed(2) : '‚ö†Ô∏è Niet ingesteld'}</td>
                    <td class="text-right font-semibold ${marge >= 0 ? 'text-green-600' : 'text-red-600'}">‚Ç¨${marge.toFixed(2)}</td>
                    <td class="text-right ${margePerc >= 40 ? 'text-green-600' : margePerc >= 20 ? 'text-amber-600' : 'text-red-600'}">${kostprijsKnown ? margePerc.toFixed(0) + '%' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Totaal rij
            const totaalMargePerc = totaalOmzet > 0 ? (totaalMarge / totaalOmzet * 100) : 0;
            margeBody.innerHTML += `<tr class="totaal-row">
                <td class="font-bold">Totaal</td>
                <td class="text-right font-bold">${totaalUren.toFixed(2)}</td>
                <td class="text-right font-bold">‚Ç¨${totaalOmzet.toFixed(2)}</td>
                <td class="text-right font-bold">‚Ç¨${totaalKosten.toFixed(2)}</td>
                <td class="text-right font-bold text-green-600">‚Ç¨${totaalMarge.toFixed(2)}</td>
                <td class="text-right font-bold">${totaalMargePerc.toFixed(0)}%</td>
            </tr>`;
        }
        
        function formatDatum(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        
        function updatePeriodeLabel(van, tot) {
            const label = document.getElementById('previewPeriode');
            if (van && tot) {
                const vd = new Date(van);
                const td = new Date(tot);
                label.textContent = `${vd.toLocaleDateString('nl-NL')} - ${td.toLocaleDateString('nl-NL')}`;
            }
        }
        
        async function exportPDF() {
            const klantId = document.getElementById('filterKlant').value;
            const locatie = document.getElementById('filterProject').value;
            const van = document.getElementById('filterVan').value;
            const tot = document.getElementById('filterTot').value;
            const inclUren = document.getElementById('inclUren').checked;
            const inclBonnen = document.getElementById('inclBonnen').checked;
            const inclReiskosten = document.getElementById('inclReiskosten').checked;
            
            const params = new URLSearchParams({
                van, tot,
                klantId: klantId || '',
                locatie: locatie || '',
                inclUren, inclBonnen, inclReiskosten
            });
            
            window.open(`/api/export/urenstaat-pdf?${params}`, '_blank');
        }
        
        function exportExcel() {
            const van = document.getElementById('filterVan').value;
            const tot = document.getElementById('filterTot').value;
            const klant = klanten.find(k => k.id === document.getElementById('filterKlant').value);
            const locatie = document.getElementById('filterProject').value;
            
            // Build CSV
            let csv = '\uFEFF'; // BOM for Excel UTF-8
            
            // Header info
            csv += 'URENSTAAT\n';
            if (klant) csv += `Opdrachtgever:;${escapeHtml(klant.naam)}\n`;
            if (locatie) csv += `Project/Locatie:;${escapeHtml(locatie)}\n`;
            csv += `Periode:;${van} - ${tot}\n`;
            csv += '\n';
            
            // Uren
            if (document.getElementById('inclUren').checked && filteredData.uren.length) {
                csv += 'UREN\n';
                csv += 'Datum;Medewerker;Locatie;Begin;Eind;Pauze;Uren\n';
                let totaalUren = 0;
                filteredData.uren.forEach(u => {
                    totaalUren += u.totaalUren || 0;
                    csv += `${u.datum};${u.medewerkerNaam || ''};${u.locatieAdres || ''};${u.begintijd};${u.eindtijd};${u.pauze || 0};${(u.totaalUren || 0).toFixed(2)}\n`;
                });
                csv += `;;;;TOTAAL;;${totaalUren.toFixed(2)}\n`;
                csv += '\n';
            }
            
            // Bonnen
            if (document.getElementById('inclBonnen').checked && filteredData.bonnen.length) {
                csv += 'MATERIALEN / BONNEN\n';
                csv += 'Datum;Medewerker;Winkel;Categorie;Bedrag\n';
                let totaal = 0;
                filteredData.bonnen.forEach(b => {
                    totaal += b.bedrag || 0;
                    csv += `${b.datum};${b.medewerkerNaam || ''};${b.winkel || ''};${b.categorie || ''};${(b.bedrag || 0).toFixed(2)}\n`;
                });
                csv += `;;;TOTAAL;${totaal.toFixed(2)}\n`;
                csv += '\n';
            }
            
            // Reiskosten
            if (document.getElementById('inclReiskosten').checked && filteredData.reiskosten.length) {
                csv += 'REISKOSTEN\n';
                csv += 'Datum;Medewerker;Omschrijving;KM;Bedrag\n';
                let totaalKm = 0, totaalBedrag = 0;
                filteredData.reiskosten.forEach(r => {
                    totaalKm += r.km || 0;
                    totaalBedrag += r.totaal || 0;
                    csv += `${r.datum};${r.medewerkerNaam || ''};${r.desc || ''};${r.km || 0};${(r.totaal || 0).toFixed(2)}\n`;
                });
                csv += `;;TOTAAL;${totaalKm};${totaalBedrag.toFixed(2)}\n`;
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `urenstaat-${van}-${tot}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        async function exportToMoneybird() {
            const klantId = document.getElementById('filterKlant').value;
            const locatie = document.getElementById('filterProject').value;
            const van = document.getElementById('filterVan').value;
            const tot = document.getElementById('filterTot').value;
            const uurtarief = parseFloat(document.getElementById('uurtarief').value) || 60;
            
            if (!klantId) {
                alert('Selecteer eerst een opdrachtgever om een factuur aan te maken.');
                return;
            }
            
            if (filteredData.uren.length === 0) {
                alert('Geen uren gevonden voor deze selectie.');
                return;
            }
            
            // Bereken totalen per medewerker
            const urenPerMedewerker = {};
            filteredData.uren.forEach(u => {
                const naam = u.medewerkerNaam || 'Onbekend';
                if (!urenPerMedewerker[naam]) urenPerMedewerker[naam] = 0;
                urenPerMedewerker[naam] += u.totaalUren || 0;
            });
            
            const totaalBonnen = filteredData.bonnen.reduce((sum, b) => sum + (b.bedrag || 0), 0);
            const totaalKm = filteredData.reiskosten.reduce((sum, r) => sum + (r.km || 0), 0);
            const totaalReiskosten = filteredData.reiskosten.reduce((sum, r) => sum + (r.totaal || 0), 0);
            
            // Bouw factuurregels
            const details = [];
            
            // Uren per medewerker
            Object.entries(urenPerMedewerker).forEach(([naam, uren]) => {
                details.push({
                    description: `Stucwerk - ${escapeHtml(naam)}`,
                    amount: uren.toFixed(2) + ' uur',
                    price: uurtarief
                });
            });
            
            // Materialen
            if (totaalBonnen > 0) {
                details.push({
                    description: 'Materialen',
                    amount: '1',
                    price: totaalBonnen
                });
            }
            
            // Reiskosten
            if (totaalReiskosten > 0) {
                details.push({
                    description: `Reiskosten (${totaalKm} km)`,
                    amount: '1',
                    price: totaalReiskosten
                });
            }
            
            // Stuur naar API
            try {
                const res = await fetch('/api/export/moneybird-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        klantId,
                        locatie,
                        van,
                        tot,
                        uurtarief,
                        details,
                        urenPerMedewerker,
                        totaalBonnen,
                        totaalKm,
                        totaalReiskosten
                    })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    alert('‚úÖ Concept factuur aangemaakt in Moneybird!\n\nFactuurnummer: ' + (data.invoiceNumber || 'concept'));
                    if (data.url) {
                        window.open(data.url, '_blank');
                    }
                } else {
                    alert('‚ùå Fout: ' + (data.error || 'Onbekende fout'));
                }
            } catch (e) {
                console.error('Moneybird export error:', e);
                alert('‚ùå Fout bij verbinden met Moneybird');
            }
        }
    </script>
</body>
</html>
